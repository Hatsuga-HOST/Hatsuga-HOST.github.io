<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Luau / Lua Obfuscator â€” Ultimate v3 (Fast)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#061226; --card:#0e1724; --muted:#9fb0cc; --fg:#e6f0ff;
  --accent1:#6d28d9; --accent2:#4f46e5; --ok:#16a34a; --danger:#ef4444;
  --glass-border: rgba(120,140,255,0.10);
  --radius:14px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:
  radial-gradient(800px 400px at 10% 10%, rgba(79,70,229,0.06), transparent),
  linear-gradient(180deg,#041022,#030812); color:var(--fg);}
.container{max-width:1100px;margin:28px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));
display:grid;place-items:center;font-weight:800;color:white;box-shadow:0 10px 30px rgba(79,70,229,0.14)}
.title{font-size:19px;font-weight:700}
.subtitle{font-size:13px;color:var(--muted)}
.grid{display:grid;gap:16px;grid-template-columns:1fr 420px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius);
 padding:16px;border:1px solid var(--glass-border); box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.large{min-height:480px;display:flex;flex-direction:column}
.textarea{width:100%;height:300px;resize:vertical;background:linear-gradient(180deg,#07132a,#06101f);
 border-radius:10px;border:1px solid rgba(255,255,255,0.03);color:var(--fg);padding:12px;font-family:ui-monospace,monospace;font-size:13px;line-height:1.45}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;background:rgba(255,255,255,0.03);color:var(--fg)}
.btn.tiny{padding:8px 10px;font-weight:600}
.btn.primary{background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 10px 22px rgba(79,70,229,0.12);color:#fff}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
.row{display:flex;gap:8px;align-items:center}
.select,input[type="text"],select{appearance:none;background:transparent;color:var(--fg);border-radius:10px;padding:8px 10px;border:1px solid rgba(255,255,255,0.03)}
.progress{height:12px;background:rgba(255,255,255,0.03);border-radius:10px;overflow:hidden}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent2),#8b5cf6);transition:width .28s ease}
.features{display:grid;gap:8px;font-size:13px;color:var(--muted)}
.feature{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px}
.feature.ok{background:linear-gradient(90deg, rgba(22,163,74,0.06), transparent);color:var(--ok)}
.feature.no{background:linear-gradient(90deg, rgba(239,68,68,0.04), transparent);color:var(--danger)}
.preview{background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:8px;padding:8px;font-family:ui-monospace,monospace;font-size:12px;color:var(--muted);max-height:120px;overflow:auto}
.small{font-size:13px;color:var(--muted)}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.switch{display:flex;gap:8px;background:rgba(255,255,255,0.01);padding:6px;border-radius:12px;align-items:center}
.badge{padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px;background:rgba(255,255,255,0.03);color:var(--muted)}
.toggle{appearance:none;width:42px;height:22px;background:rgba(0,0,0,0.14);border-radius:999px;position:relative;cursor:pointer;outline:none;border:1px solid rgba(255,255,255,0.03)}
.toggle:checked{background:linear-gradient(90deg,var(--accent1),var(--accent2))}
.toggle::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;top:1px;left:2px;background:white;transition:all .18s}
.toggle:checked::after{left:22px;transform:scale(.98)}
.actionRow{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.small-ghost{background:transparent;color:var(--muted);border:1px dashed rgba(255,255,255,0.03);padding:8px;border-radius:9px}
.toast-wrap{position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:10px;background:rgba(6,18,36,0.92);border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(0,0,0,0.6);min-width:220px}
.toast .tmsg{font-size:13px}
.svg-icon{width:16px;height:16px;display:inline-block;vertical-align:middle}
.legend{font-size:12px;color:var(--muted);margin-top:8px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">LðŸ”’</div>
      <div>
        <div class="title">Luau / Lua Obfuscator â€” Ultimate v3 (Fast)</div>
        <div class="subtitle">Target: Luau & Lua 5.1 â€¢ Deterministic key â€¢ Fast local obfuscation</div>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="small">Free â€¢ Local</div>
      <button class="btn ghost" id="sampleBtn">
        <!-- upload SVG -->
        <svg class="svg-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3v12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Insert Sample
      </button>
      <button class="btn tiny" id="helpBtn">
        <svg class="svg-icon" viewBox="0 0 24 24" fill="none"><path d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 17v.01M12 7a3 3 0 00-2 5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Help
      </button>
    </div>
  </div>

  <div class="grid">
    <!-- left -->
    <div class="card large">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="small">1) Source â€” paste atau upload</div>
          <div class="hint">Supports Luau and Lua 5.1. Keep large long-bracket strings intact.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="fileInput" type="file" accept=".lua,.txt" style="display:none"/>
          <button class="btn" id="uploadBtn">
            <svg class="svg-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6"/><path d="M8 7l4-4 4 4" stroke="currentColor" stroke-width="1.6"/></svg>
            Upload
          </button>
          <button class="btn" id="clearIn">Clear</button>
        </div>
      </div>

      <textarea id="inputArea" class="textarea" placeholder="-- Paste your Luau / Lua 5.1 code here"></textarea>

      <div class="controls">
        <div class="row">
          <div class="small">Target</div>
          <select id="targetSelect" class="select">
            <option value="luau">Luau (Roblox)</option>
            <option value="lua51">Lua 5.1</option>
          </select>
        </div>

        <div class="row">
          <div class="small">Level</div>
          <select id="levelSelect" class="select"></select>
        </div>

        <div class="row">
          <div class="small">Key (optional)</div>
          <input id="keyInput" type="text" placeholder="deterministic key / salt"/>
        </div>

        <div class="row switch">
          <div class="small">Anti-tamper</div>
          <input type="checkbox" id="antiTamper" class="toggle"/>
          <div class="small">Multi-wrap</div>
          <input type="checkbox" id="multiWrap" class="toggle" checked/>
        </div>

        <div style="flex:1"></div>
        <div style="display:flex;gap:8px">
          <button class="btn primary" id="runBtn">
            <svg class="svg-icon" viewBox="0 0 24 24" fill="none"><path d="M5 3v18l15-9L5 3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            Obfuscate
          </button>
          <button class="btn" id="previewBtn">Preview</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Progress</div>
        <div class="progress"><i id="progressBar"></i></div>
      </div>

      <div style="display:flex;gap:12px;align-items:flex-start;margin-top:12px">
        <div style="width:60%">
          <div class="features" id="featureList"></div>
        </div>
        <div style="flex:1">
          <div class="small-ghost small" id="stats">No output</div>
          <div class="legend">Tip: gunakan key untuk deterministic rename & XOR</div>
        </div>
      </div>
    </div>

    <!-- right -->
    <div class="card">
      <div class="small">Features by level</div>
      <div class="preview" id="featPreview">Pilih level untuk melihat rangkuman.</div>

      <div style="margin-top:10px">
        <div class="small">Output actions</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" id="copyBtn">
            <svg class="svg-icon" viewBox="0 0 24 24" fill="none"><rect x="9" y="9" width="10" height="10" stroke="currentColor" stroke-width="1.4"/><rect x="5" y="5" width="10" height="10" stroke="currentColor" stroke-width="1.4"/></svg>
            Copy
          </button>
          <button class="btn" id="downloadBtn">
            <svg class="svg-icon" viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.6"/><path d="M5 21h14" stroke="currentColor" stroke-width="1.6"/></svg>
            Download
          </button>
          <button class="btn" id="clearOutBtn">Clear</button>
          <button class="btn" id="openWindowBtn">Open</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Output</div>
        <textarea id="outputArea" class="textarea" style="height:220px" readonly placeholder="Obfuscated output will appear here"></textarea>
        <div class="small" style="margin-top:6px">Lines: <span id="outLines">0</span> â€¢ Size: <span id="outSize">0</span> KB</div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Quick tips</div>
        <ul class="small" style="padding-left:18px">
          <li>Luau: loadstring sering dinonaktifkan â€” loader coba pakai load atau pcall.</li>
          <li>Gunakan key untuk membuat rename & string xor konsisten.</li>
          <li>Level tinggi mempersulit debugging â€” simpan versi original.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- toast container -->
<div class="toast-wrap" id="toastWrap"></div>

<script>
/* Fast Luau / Lua obfuscator â€” synchronous pipeline
   - quick but practical transforms (regex-based)
   - not AST-perfect; effective for common scripts
*/

// small helpers
const $ = id => document.getElementById(id);
const toastWrap = $('toastWrap');
function showToast(msg, type='info'){
  const t = document.createElement('div'); t.className = 'toast';
  const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svg.setAttribute('class','svg-icon'); svg.setAttribute('viewBox','0 0 24 24');
  svg.setAttribute('fill','none');
  if (type==='ok'){
    svg.innerHTML = '<path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>';
  } else if (type==='err'){
    svg.innerHTML = '<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>';
  } else {
    svg.innerHTML = '<path d="M12 2a10 10 0 100 20 10 10 0 000-20zM12 17v.01M12 7a3 3 0 00-2 5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>';
  }
  const txt = document.createElement('div'); txt.className='tmsg'; txt.innerText=msg;
  t.appendChild(svg); t.appendChild(txt);
  toastWrap.appendChild(t);
  setTimeout(()=>{ t.style.opacity=1; },10);
  setTimeout(()=>{ t.style.opacity=0; t.addEventListener('transitionend',()=>t.remove()) }, 3000);
}

// populate levels and features (SVG check/cross)
const levelSelect = $('levelSelect'), featPreview = $('featPreview'), featureList = $('featureList');
const levelFeatures = [
  "Minify whitespace & comments",
  "Safe variable rename (skip keywords/globals)",
  "Encode strings (xor -> base64) + runtime decoder",
  "Inject safe junk functions",
  "Flatten flow (runner parts)",
  "Extra junk & opaque locals",
  "Multi-wrap via load/loadstring",
  "Anti-tamper runtime guard",
  "Heavy wrapper layers",
  "Mix junk + flatten + heavy wrap"
];
for (let i=1;i<=10;i++){ const op = document.createElement('option'); op.value=i; op.text=`Level ${i}`; levelSelect.appendChild(op); }
levelSelect.value=6; renderFeatures(6);

function svgCheck(){ return '<svg class="svg-icon" viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }
function svgCross(){ return '<svg class="svg-icon" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>'; }

function renderFeatures(lvl){
  featureList.innerHTML='';
  featPreview.innerText = `Level ${lvl} includes:\n` + levelFeatures.slice(0,lvl).map((v,i)=>`â€¢ ${v}`).join('\n');
  for (let i=0;i<levelFeatures.length;i++){
    const div = document.createElement('div'); div.className='feature ' + (i<lvl?'ok':'no');
    div.innerHTML = (i<lvl?svgCheck():svgCross()) + '<div style="font-weight:700;margin-left:6px">'+levelFeatures[i]+'</div>';
    featureList.appendChild(div);
  }
  $('progressBar').style.width = (lvl*10) + '%';
}
levelSelect.addEventListener('change', ()=> renderFeatures(parseInt(levelSelect.value)));

// utils
const LUA_KEYWORDS = new Set(["and","break","do","else","elseif","end","false","for","function","goto","if","in","local","nil","not","or","repeat","return","then","true","until","while"]);
const COMMON_GLOBALS = new Set(["_G","_ENV","print","warn","require","pairs","ipairs","next","type","tonumber","tostring","math","string","table","coroutine","os","package","io","loadstring","load","pcall","xpcall","spawn","task","workspace","game","script","tick","delay"]);

// hash for deterministic renames
function hashString(s){
  let h=2166136261;
  for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h += (h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24); }
  return (h>>>0).toString(36);
}
function nameFromKey(orig, key, idx){ const h = hashString((key||"") + ":" + orig + ":" + idx).substr(0,6); return "_" + h; }

function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

// 1) minify - keep long bracket strings safe
function minifyLua(src){
  // preserve long bracket groups by placeholders
  const longs = [];
  src = src.replace(/(\[=*\[)([\s\S]*?)(\]=*\])/g, function(m){ const key = '___LB'+longs.length+'___'; longs.push(m); return `"${key}"`; });
  // remove long comments --[[...]]
  src = src.replace(/--\[\[([\s\S]*?)\]\]/g, '');
  // remove line comments after code
  src = src.replace(/--.*$/gm, '');
  // collapse whitespace but keep newlines to help some flattening
  src = src.replace(/\r\n/g,'\n').replace(/[ \t]+\n/g,'\n').replace(/\n{3,}/g,'\n\n');
  // trim lines
  src = src.split('\n').map(l=>l.trim()).join('\n');
  // restore long brackets
  for (let i=0;i<longs.length;i++) src = src.replace(`"___LB${i}___"`, longs[i]);
  return src.trim();
}

// 2) extract identifiers
function extractIdentifiers(code){
  const ids = new Set();
  const re = /\b([A-Za-z_][A-Za-z0-9_]*)\b/g;
  let m;
  while((m = re.exec(code)) !== null){
    const id = m[1];
    if (LUA_KEYWORDS.has(id)) continue;
    if (COMMON_GLOBALS.has(id)) continue;
    ids.add(id);
  }
  return Array.from(ids);
}

// 3) safe rename (synchronous)
function safeRename(code, key){
  const ids = extractIdentifiers(code).sort((a,b)=>b.length-a.length);
  const mapping = {};
  for (let i=0;i<ids.length;i++){ mapping[ids[i]] = nameFromKey(ids[i], key, i); }
  // replace but skip occurrences preceded by . or : or [  (table access)
  for (const orig of Object.keys(mapping)){
    const re = new RegExp('\\b' + escapeRegExp(orig) + '\\b','g');
    code = code.replace(re, (m, offset) => {
      const before = code[offset-1] || '';
      if (before === '.' || before === ':' || before === '[') return m;
      if (LUA_KEYWORDS.has(m)) return m;
      return mapping[orig];
    });
  }
  return code;
}

// 4) encode strings -> produce __DECODE(...) and __DECODE_LONG(...)
function encodeStrings(code, key){
  // find quoted strings and long brackets and replace with placeholders
  const parts = [];
  let out = '';
  let i = 0;
  while (i < code.length){
    const ch = code[i];
    if (ch === '"' || ch === "'"){
      const q = ch; let j = i+1, esc=false, buf = '';
      while (j < code.length){
        const c = code[j];
        if (!esc && c === q){ j++; break; }
        if (!esc && c === '\\'){ esc=true; buf += c; j++; continue; }
        buf += c; esc=false; j++;
      }
      parts.push({type:'q', quote:q, text:buf});
      out += `__STR_PLACE_${parts.length-1}__`;
      i = j; continue;
    }
    // long bracket
    if (ch === '[' && (code[i+1] === '[' || code[i+1] === '=')){
      const m = code.slice(i).match(/^(\[=*\[)/);
      if (m){
        const open = m[1];
        const close = open.replace('[',']');
        const idx = code.indexOf(close, i+open.length);
        let content, j;
        if (idx >= 0){ content = code.slice(i+open.length, idx); j = idx + close.length; }
        else { content = code.slice(i); j = code.length; }
        parts.push({type:'lb', text:content});
        out += `__STR_PLACE_${parts.length-1}__`;
        i = j; continue;
      }
    }
    out += ch; i++;
  }
  // encode each part
  const encParts = parts.map(p=>{
    const xorKey = (key||'') || String.fromCharCode(42);
    const s = p.text;
    // xor bytes
    let bytes = [];
    for (let i=0;i<s.length;i++){ const code = s.charCodeAt(i) ^ xorKey.charCodeAt(i % xorKey.length); bytes.push(String.fromCharCode(code)); }
    const b64 = btoa(bytes.join(''));
    if (p.type === 'lb') return `__DECODE_LONG("${b64}")`;
    return `__DECODE("${b64}")`;
  });
  // replace placeholders
  let final = out.replace(/__STR_PLACE_(\d+)__/g, (_, n) => encParts[Number(n)]);
  return final;
}

// runtime decoder snippet (works in Luau & Lua5.1)
function runtimeDecoderSnippet(key){
  // uses bitwise fallback for Luau / Lua 5.1 compatibility
  const jsKey = key || '';
  // We'll produce Lua code as string
  const snippet = `
-- Runtime decoder injected by obfuscator
local __OBF_KEY = ${JSON.stringify(jsKey)}
local function __b64dec(s)
  local b='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
  s = string.gsub(s, '[^'..b..'=]', '')
  local t={}
  local p=1
  for i=1,#s,4 do
    local c1 = string.find(b, s:sub(i,i)) or 0
    local c2 = string.find(b, s:sub(i+1,i+1)) or 0
    local c3 = string.find(b, s:sub(i+2,i+2)) or 0
    local c4 = string.find(b, s:sub(i+3,i+3)) or 0
    local n = c1*262144 + c2*4096 + c3*64 + c4
    local a = math.floor(n / 65536) % 256
    local b_ = math.floor(n / 256) % 256
    local c_ = n % 256
    if s:sub(i+2,i+2) == '=' then
      t[p] = string.char(a); p=p+1
    elseif s:sub(i+3,i+3) == '=' then
      t[p] = string.char(a); t[p+1] = string.char(b_); p=p+2
    else
      t[p] = string.char(a); t[p+1] = string.char(b_); t[p+2] = string.char(c_); p=p+3
    end
  end
  return table.concat(t)
end

local function __xorstr(s)
  if __OBF_KEY == '' then return s end
  local out = {}
  for i=1,#s do
    local a = string.byte(s, i)
    local k = string.byte(__OBF_KEY, ((i-1) % #__OBF_KEY)+1)
    -- bitwise xor handling (Luau supports ~, Lua5.1 may have bit32)
    if bit32 and bit32.bxor then
      out[i] = string.char(bit32.bxor(a,k))
    else
      -- try use bitwise xor operator if available (~), otherwise approximate via arithmetic (less ideal)
      local ok, res = pcall(function() return a ~ k end)
      if ok then out[i] = string.char(res) else out[i] = string.char((a + k) % 256) end
    end
  end
  return table.concat(out)
end

function __DECODE(b64)
  local dec = __b64dec(b64)
  return __xorstr(dec)
end

function __DECODE_LONG(b64)
  return __DECODE(b64)
end
`;
  return snippet;
}

// small junk injection generator
function injectJunk(n){
  let out = '';
  for (let i=0;i<n;i++){
    const id = '_jx' + Math.random().toString(36).substr(2,6);
    out += `local ${id} = function(...) return ... end\n`;
  }
  return out;
}

// flatten simple: split into parts and run sequentially via pcall
function flattenCode(code){
  const lines = code.split('\n').filter(l=>l.trim().length>0);
  const parts = [];
  const chunkSize = Math.max(1, Math.ceil(lines.length / Math.min(8, Math.max(2, Math.floor(lines.length/6)))));
  for (let i=0;i<lines.length;i+=chunkSize) parts.push(lines.slice(i,i+chunkSize).join('\n'));
  let out = "do\n local __parts = {}\n";
  for (let i=0;i<parts.length;i++){
    out += ` __parts[${i+1}] = function()\n${parts[i]}\n end\n`;
  }
  out += " local __i=1 while __i<=#__parts do local ok = pcall(__parts[__i]); if not ok then break end; __i=__i+1 end\nend\n";
  return out;
}

// multiWrap: wrap with base64 encoded loadstring wrapper(s)
function multiWrap(code, layers=1, target='lua51'){
  let current = code;
  for (let i=0;i<layers;i++){
    const b64 = btoa(current);
    // wrapper supports loadstring or load
    const wrapper = `
do
  local __s = "${b64}"
  local __fn
  local ok,err = pcall(function()
    local loader = rawget(_G or {}, "loadstring") or load
    if type(loader) ~= "function" then loader = load end
    local decoded = __DECODE(__s)
    __fn = (loader and loader(decoded)) or nil
  end)
  if type(__fn) == "function" then __fn() end
end
`;
    current = wrapper;
  }
  return current;
}

// anti-tamper
function antiTamperWrap(code){
  const guard = `do
local __g = "__OBF_G"..tostring(math.random(1000,9999))
if rawget(_G or {}, "__OBF_GUARD") then error("Tamper detected") end
rawset(_G or {}, "__OBF_GUARD", __g)
end
`;
  return guard + "\n" + code;
}

// pipeline (synchronous)
function obfuscateSync(src, opts){
  let out = src;
  const lvl = opts.level || 1;
  // 1 minify
  if (lvl >= 1) out = minifyLua(out);
  // 2 rename
  if (lvl >= 2) out = safeRename(out, opts.key || '');
  // 3 encode strings
  if (lvl >= 3) out = encodeStrings(out, opts.key || '');
  // 4 junk
  if (lvl >= 4) out = injectJunk(Math.min(4, Math.max(1, Math.floor(lvl/2)))) + "\n" + out;
  // 5 flatten
  if (lvl >= 5) out = flattenCode(out);
  // 6 extra junk
  if (lvl >= 6) out = injectJunk(3) + "\n" + out;
  // 7 multiwrap
  if (lvl >= 7 && opts.multiWrap) out = multiWrap(out, 1 + Math.floor((lvl-7+1)/2), opts.target);
  // 8 anti-tamper
  if (lvl >= 8 && opts.antiTamper) out = antiTamperWrap(out);
  // 9 heavy wrap
  if (lvl >= 9 && opts.multiWrap) out = multiWrap(out, 2 + Math.floor((lvl-8)/2), opts.target);
  // 10 mix
  if (lvl >= 10) out = injectJunk(2) + "\n" + flattenCode(out);

  // always prepend runtime decoder (if level>=3) to allow string decode
  if (lvl >= 3) out = runtimeDecoderSnippet(opts.key || '') + "\n" + out;

  return out;
}

// UI wiring
$('uploadBtn').addEventListener('click', ()=>$('fileInput').click());
$('fileInput').addEventListener('change', e=>{
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ()=> $('inputArea').value = r.result;
  r.readAsText(f);
});
$('clearIn').addEventListener('click', ()=> $('inputArea').value = '');

$('sampleBtn').addEventListener('click', ()=> {
  const sample = `-- Sample Luau / Lua 5.1
local function greet(name)
  print("Hello, "..name.."!")
end
greet("world")
`;
  $('inputArea').value = sample;
});

$('runBtn').addEventListener('click', ()=> {
  const src = $('inputArea').value || '';
  if (!src.trim()){ showToast('Paste code first', 'err'); return; }
  const lvl = parseInt($('levelSelect').value);
  const key = $('keyInput').value || '';
  const target = $('targetSelect').value;
  const antiTamper = $('antiTamper').checked;
  const multiWrap = $('multiWrap').checked;

  try {
    const t0 = performance.now();
    // perform synchronous obfuscation (fast)
    const out = obfuscateSync(src, {level: lvl, key, target, antiTamper, multiWrap});
    $('outputArea').value = out;
    $('outLines').innerText = out.split('\n').length;
    $('outSize').innerText = (out.length/1024).toFixed(2);
    $('stats').innerText = `Done â€¢ ${Math.round(performance.now()-t0)} ms â€¢ Level ${lvl} â€¢ ${target}`;
    $('progressBar').style.width = '100%';
    showToast('Obfuscation complete', 'ok');
  } catch (err){
    showToast('Error during obfuscation: ' + (err && err.message ? err.message : err), 'err');
    console.error(err);
  }
});

$('previewBtn').addEventListener('click', ()=>{
  const src = $('inputArea').value || '';
  if (!src.trim()){ showToast('Paste code first', 'err'); return; }
  const lvl = parseInt($('levelSelect').value);
  const key = $('keyInput').value || '';
  const out = obfuscateSync(src, {level:lvl, key, target:$('targetSelect').value, antiTamper:$('antiTamper').checked, multiWrap:$('multiWrap').checked});
  const preview = out.slice(0, 800);
  // show in toast or new window if long
  const w = window.open('', '_blank');
  w.document.title = 'Preview â€” obf';
  w.document.body.style.background = '#071226';
  const pre = w.document.createElement('pre');
  pre.style.whiteSpace='pre-wrap'; pre.style.fontFamily='monospace';
  pre.style.color='#dbeaff'; pre.style.padding='12px';
  pre.textContent = preview + (out.length>800? '\n\n... (truncated)':'');
  w.document.body.appendChild(pre);
});

$('copyBtn').addEventListener('click', async ()=>{
  const v = $('outputArea').value; if (!v){ showToast('No output', 'err'); return; }
  try { await navigator.clipboard.writeText(v); showToast('Copied to clipboard', 'ok'); } catch { showToast('Clipboard failed', 'err'); }
});

$('downloadBtn').addEventListener('click', ()=> {
  const v = $('outputArea').value; if (!v){ showToast('No output', 'err'); return; }
  const blob = new Blob([v], {type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `luobf-${Date.now()}.lua`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
});

$('clearOutBtn').addEventListener('click', ()=> {
  $('outputArea').value=''; $('outLines').innerText='0'; $('outSize').innerText='0'; $('stats').innerText='No output';
});

$('openWindowBtn').addEventListener('click', ()=> {
  const v = $('outputArea').value; if (!v){ showToast('No output', 'err'); return; }
  const w = window.open('', '_blank'); w.document.title='Obfuscated'; const pre = w.document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.fontFamily='monospace'; pre.style.padding='12px'; pre.style.background='#071226'; pre.style.color='#dbeaff'; pre.textContent = v; w.document.body.appendChild(pre);
});

$('helpBtn').addEventListener('click', ()=> {
  const help = `Quick Help:
- Paste Luau/Lua 5.1 code (or upload .lua/.txt).
- Pilih target (Luau / Lua 5.1), level, dan optional key.
- Tekan Obfuscate -> hasil ditampilkan di kanan.
Notes:
- Level >=3 meng-encode strings: runtime decoder akan disisipkan.
- Be careful: level tinggi mempersulit debugging. Simpan original.`;
  showToast(help, 'info');
});

// small init
document.addEventListener('DOMContentLoaded', ()=> {
  renderFeatures(parseInt(levelSelect.value));
  $('progressBar').style.width = (parseInt(levelSelect.value)*10) + '%';
});

// base64 helpers
function btoa(str){
  try { return window.btoa(unescape(encodeURIComponent(str))); } catch(e){
    let bin=''; for (let i=0;i<str.length;i++) bin += String.fromCharCode(str.charCodeAt(i) & 0xff); return window.btoa(bin);
  }
}

</script>
</body>
</html>
